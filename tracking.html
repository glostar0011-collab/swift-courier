<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Tracking Terminal | SwiftCourier Global</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --purple: #4D148C; --orange: #FF6200; --navy: #02060f; --white: #FFFFFF; --green: #00E676; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #fdfdfd; color: var(--navy); line-height: 1.5; }

        /* TERMINAL TOP BAR */
        .top-bar { background: #000; color: #00ff00; padding: 10px 8%; font-family: monospace; font-size: 11px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--purple); }

        /* HEADER */
        header { background: var(--navy); padding: 30px 8%; display: flex; justify-content: space-between; align-items: center; color: white; }
        .logo { font-family: 'Montserrat'; font-size: 26px; font-weight: 900; text-decoration: none; color: white; }
        .logo span { color: var(--orange); }

        /* STATUS DISPLAY */
        .status-hero { background: var(--purple); color: white; padding: 80px 8%; text-align: center; background-image: radial-gradient(circle at center, #6a1b9a, #4D148C); }
        .status-hero h1 { font-family: 'Montserrat'; font-size: 50px; margin: 0; text-transform: uppercase; line-height: 1; }
        .track-id-badge { display: inline-block; background: rgba(255,255,255,0.15); padding: 8px 25px; border-radius: 50px; margin-top: 20px; font-weight: 600; font-size: 14px; border: 1px solid rgba(255,255,255,0.3); }

        /* DASHBOARD GRID */
        .dashboard { max-width: 1400px; margin: -50px auto 100px; padding: 0 20px; display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 40px; }

        /* MAIN CARD */
        .main-card { background: white; border-radius: 8px; padding: 50px; box-shadow: 0 40px 100px rgba(0,0,0,0.08); }
        .progress-bar-wrap { position: relative; display: flex; justify-content: space-between; margin: 60px 0; }
        .bg-line { position: absolute; top: 25px; height: 4px; background: #eee; width: 100%; z-index: 1; }
        .fill-line { position: absolute; top: 25px; height: 4px; background: var(--orange); width: 0%; z-index: 2; transition: width 2s ease-in-out; }
        .step-node { position: relative; z-index: 3; text-align: center; width: 120px; }
        .circle { width: 54px; height: 54px; background: white; border: 5px solid #eee; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; }
        .step-node.active .circle { border-color: var(--orange); color: var(--orange); box-shadow: 0 0 20px rgba(255,98,0,0.3); }
        .step-node.done .circle { background: var(--orange); border-color: var(--orange); color: white; }
        .step-label { font-size: 11px; font-weight: 800; color: #bbb; text-transform: uppercase; letter-spacing: 1px; }

        /* DATA TABLE */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 40px; }
        .data-table th { text-align: left; padding: 15px; background: #f8f9fa; font-size: 12px; color: #777; border-bottom: 2px solid #eee; }
        .data-table td { padding: 20px 15px; border-bottom: 1px solid #f1f1f1; font-size: 14px; }

        /* SIDEBAR - THE FIX IS HERE */
        .sidebar-card { background: var(--navy); color: white; padding: 40px; border-radius: 8px; position: sticky; top: 120px; overflow: hidden; }
        .sidebar-card h3 { color: var(--orange); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 25px; font-family: 'Montserrat'; }
        
        .spec-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
        .spec-row label { opacity: 0.5; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .spec-row span { font-weight: 700; font-size: 15px; text-align: right; }
        .weight-val { color: var(--orange); font-size: 18px !important; }

        /* MAP BOX FIX */
        .map-container { margin-top: 35px; height: 300px; border-radius: 8px; overflow: hidden; background: #000; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        #map-embed { width: 100%; height: 100%; border: 0; filter: contrast(1.1) brightness(0.9); }

        /* GATEKEEPER LOADER */
        #gatekeeper { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #00ff00; font-family: monospace; }
        .scanline { width: 250px; height: 2px; background: #00ff00; box-shadow: 0 0 15px #00ff00; animation: scan 2s linear infinite; }
        @keyframes scan { 0% { transform: translateY(-40px); } 100% { transform: translateY(40px); } }

        @media (max-width: 1024px) { 
            .dashboard { grid-template-columns: 1fr; } 
            .progress-bar-wrap { flex-direction: column; align-items: flex-start; gap: 40px; padding-left: 30px; } 
            .bg-line, .fill-line { display: none; }
            .sidebar-card { position: static; }
        }
    </style>
</head>
<body>

<div id="gatekeeper">
    <div class="scanline"></div>
    <p style="margin-top: 25px; letter-spacing: 2px;">AUTHORIZING ACCESS...</p>
</div>

<div class="top-bar">
    <div>SYSTEM: SWIFT-CORE v4.2 // SECURITY: ACTIVE</div>
    <div>HUB TIME: <span id="clock"></span></div>
</div>

<header>
    <a href="index.html" class="logo">SWIFT<span>COURIER</span></a>
    <div style="font-size: 11px; font-weight: bold; border: 1px solid var(--green); padding: 6px 16px; color: var(--green); border-radius: 4px; text-transform: uppercase;">Secure Terminal</div>
</header>

<section class="status-hero">
    <div class="track-id-badge" id="badge-id">LOADING...</div>
    <h1 id="hero-status-text">RETRIEVING DATA</h1>
</section>

<div class="dashboard">
    <div class="main-card">
        <h3 style="margin-top:0; font-family:'Montserrat';">LIVE LIFECYCLE MONITOR</h3>
        <div class="progress-bar-wrap">
            <div class="bg-line"></div>
            <div class="fill-line" id="progress-line-fill"></div>
            <div class="step-node" id="s1"><div class="circle">1</div><div class="step-label">Ordered</div></div>
            <div class="step-node" id="s2"><div class="circle">2</div><div class="step-label">Hub Export</div></div>
            <div class="step-node" id="s3"><div class="circle">3</div><div class="step-label">In Transit</div></div>
            <div class="step-node" id="s4"><div class="circle">4</div><div class="step-label">Destination</div></div>
            <div class="step-node" id="s5"><div class="circle">5</div><div class="step-label">Delivered</div></div>
        </div>

        <h3 style="margin-top: 60px; font-family:'Montserrat';">SECURITY AUDIT LOGS</h3>
        <table class="data-table">
            <thead>
                <tr><th>LOG TIMESTAMP</th><th>CURRENT FACILITY</th><th>PROTOCOL EVENT</th><th>STATUS</th></tr>
            </thead>
            <tbody id="audit-logs">
                </tbody>
        </table>
    </div>

    <aside>
        <div class="sidebar-card">
            <h3>Shipment Specs</h3>
            <div class="spec-row"><label>Tracking ID</label><span id="side-id">---</span></div>
            <div class="spec-row"><label>Service Class</label><span>Enterprise Priority</span></div>
            <div class="spec-row"><label>Gross Weight</label><span id="side-weight" class="weight-val">---</span></div>
            <div class="spec-row"><label>Origin</label><span id="side-origin">---</span></div>
            <div class="spec-row"><label>Destination</label><span id="side-dest">---</span></div>
            <div class="spec-row"><label>Insurance</label><span style="color:var(--green)">COVERED</span></div>
            
            <div class="map-container">
                <iframe id="map-embed" src="" allowfullscreen="" loading="lazy"></iframe>
            </div>

            <button onclick="window.print()" style="width:100%; margin-top:25px; padding:18px; background:var(--orange); color:white; border:none; font-weight:900; cursor:pointer; border-radius: 4px; text-transform: uppercase;">Print Official Manifest</button>
        </div>
    </aside>
</div>

<script>
    const apiURL = 'https://script.google.com/macros/s/AKfycbxrZ2ZuqFVIAjEg8x16GXy1V0KHcMiqyJPH3PXeWnWYZizGCxy2kUKfjlcFYhos5FI/exec'; 

    async function initializePortal() {
        const id = new URLSearchParams(window.location.search).get('id');
        if(!id) return window.location.href = 'index.html';

        try {
            const resp = await fetch(`${apiURL}?id=${encodeURIComponent(id)}`);
            const data = await resp.json();
            if(data && data.id) {
                populatePortal(data);
            } else {
                handleError(id);
            }
        } catch(e) {
            handleError("Timeout");
        }
    }

    function populatePortal(data) {
        document.getElementById('gatekeeper').style.display = 'none';
        
        // Populate Strings
        document.getElementById('badge-id').innerText = "TRACKING #" + data.id;
        document.getElementById('hero-status-text').innerText = data.status;
        document.getElementById('side-id').innerText = data.id;
        document.getElementById('side-weight').innerText = (data.weight || "0.0") + " KG";
        document.getElementById('side-origin').innerText = data.origin || "Global Hub";
        document.getElementById('side-dest').innerText = data.destination || "Secured Address";

        // Map Fix
        const mapFrame = document.getElementById('map-embed');
        if(data.map && data.map.toString().includes('http')) {
            mapFrame.src = data.map;
        } else {
            document.querySelector('.map-container').style.display = 'none';
        }

        // Status Logic
        const s = data.status.toLowerCase();
        let step = 1;
        let fill = 0;

        if (s.includes("origin") || s.includes("ordered")) { step = 1; fill = 0; }
        else if (s.includes("export") || s.includes("hub") || s.includes("departed")) { step = 2; fill = 25; }
        else if (s.includes("transit") || s.includes("shipped")) { step = 3; fill = 50; }
        else if (s.includes("destination") || s.includes("delivery")) { step = 4; fill = 75; }
        else if (s.includes("delivered") || s.includes("arrived")) { step = 5; fill = 100; }

        document.getElementById('progress-line-fill').style.width = fill + "%";
        for(let i=1; i<=5; i++) {
            const node = document.getElementById('s'+i);
            if(i < step) node.classList.add('done');
            if(i === step) node.classList.add('active');
        }

        // Audit Logs
        const logs = [
            { d: "SYSTEM LIVE", l: data.origin || "HUB", e: "Status set to: " + data.status, s: "VERIFIED" },
            { d: "HUB CHECK", l: "Global Dispatch", e: "Customs declaration and manifest validated.", s: "COMPLETE" },
            { d: "INIT", l: "System Central", e: "Secure transit request logged.", s: "SECURE" }
        ];

        document.getElementById('audit-logs').innerHTML = logs.map(l => `
            <tr><td>${l.d}</td><td>${l.l}</td><td>${l.e}</td><td style="color:var(--purple); font-weight:900;">${l.s}</td></tr>
        `).join('');
    }

    function handleError(msg) {
        document.getElementById('gatekeeper').innerHTML = `
            <h2 style="color:var(--orange)">CONSIGNMENT ERROR</h2>
            <p style="color:white; opacity:0.6;">ID "${msg}" not found in our secure database.</p>
            <button onclick="window.location.href='index.html'" style="margin-top:20px; padding:12px 25px; background:var(--purple); color:white; border:none; cursor:pointer; font-weight:bold;">RETURN TO TERMINAL</button>
        `;
    }

    function updateHubClock() {
        if(document.getElementById('clock')) document.getElementById('clock').innerText = new Date().toUTCString();
    }
    setInterval(updateHubClock, 1000);
    initializePortal();
</script>

</body>
</html>
